<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weather Board Pro - Rounding Logic</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
    <style>
        :root {
            --bg-color: #000;
            --main-text: #fff;
            --sub-text: #777;
            --label-text: #aaa;
            --dim-text: #fff; 
            --border-color: #333;
            --parent-bg: #111;
        }

        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg-color); color: var(--main-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; -webkit-user-select: none; user-select: none; }
        #container { display: flex; width: 100%; height: 100%; cursor: pointer; position: relative; }
        
        #left { flex: 40; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); height: 100%; z-index: 2; background: var(--bg-color); box-sizing: border-box; }
        #right { flex: 60; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0; box-sizing: border-box; }
        #right::-webkit-scrollbar { width: 0; }

        .weather-section { height: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; padding: 2vh 0; box-sizing: border-box; }
        .section-label { font-size: 4vh; color: #fff; letter-spacing: 0.1em; font-weight: bold; margin-bottom: 2vh; text-transform: uppercase; }
        .top-row { display: flex; align-items: center; justify-content: center; gap: 3vw; margin-bottom: 1vh; }
        .clock-display { font-size: 10vh; color: var(--dim-text); font-weight: 300; font-variant-numeric: tabular-nums; line-height: 1; }
        .icon-display { font-size: 11vh; width: 15vh; height: 12vh; display: flex; align-items: center; justify-content: center; filter: brightness(1.6); }
        .bottom-row { display: flex; align-items: center; justify-content: center; gap: 4vw; }
        .temp-display { font-size: 13.5vh; font-weight: bold; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .temp-max-min { font-size: 8.5vh; font-weight: bold; color: #fff; line-height: 1; font-variant-numeric: tabular-nums; }
        .temp-divider { width: 100%; height: 2px; background: #444; margin: 6px 0; }
        .details-group { display: flex; flex-direction: column; justify-content: center; gap: 0.8vh; }
        .current-detail { display: flex; align-items: baseline; font-size: 5.8vh; font-weight: bold; }
        .detail-label { font-size: 2vh; color: var(--sub-text); width: 7vh; font-weight: bold; margin-right: 6px; }
        .num-val { display: inline-block; width: 8.5vh; text-align: right; font-variant-numeric: tabular-nums; }
        .unit { font-size: 2.8vh; color: var(--label-text); margin-left: 2px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; border-spacing: 0; }
        thead { position: sticky; top: 0; background: var(--bg-color); z-index: 10; }
        th { color: var(--label-text); font-size: 2.5vh; border-bottom: 2px solid #333; height: 8vh; vertical-align: middle; font-weight: bold; text-align: center; }
        
        th:nth-child(1) { width: 24%; } 
        th:nth-child(2) { width: 18%; } 
        th:nth-child(3) { width: 18%; } 
        th:nth-child(4) { width: 15%; } 
        th:nth-child(5) { width: 15%; } 
        th:nth-child(6) { width: 10%; } 

        td { text-align: center; vertical-align: middle; font-variant-numeric: tabular-nums; padding: 0; border-bottom: 1px solid #1a1a1a; }
        
        .parent-row { background: var(--parent-bg); border-bottom: 2px solid #333; cursor: pointer; }
        .parent-row td { font-size: 8vh; height: 23vh; font-weight: 800; }
        .time-data { text-align: right !important; padding-right: 3vw !important; }
        
        .child-row { display: none; background: #000; }
        .child-row td { font-size: 5vh; height: 12vh; color: #999; }
        .child-row.show { display: table-row; }

        .h-icon { filter: brightness(1.6); display: inline-block; vertical-align: middle; }
        .parent-row .h-icon { font-size: 11vh; }
        .child-row .h-icon { font-size: 7vh; }
        .toggle-icon { font-size: 6vh; color: #444; font-family: monospace; }

        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #modal { background: #111; padding: 30px; border: 1px solid #333; border-radius: 16px; width: 340px; box-sizing: border-box; }
        #modal h2 { margin-top: 0; font-size: 16px; color: var(--label-text); text-align: center; letter-spacing: 3px; margin-bottom: 25px; font-weight: bold; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; font-size: 11px; color: #555; margin-bottom: 6px; font-weight: bold; }
        .input-group input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 12px; box-sizing: border-box; font-size: 16px; border-radius: 8px; outline: none; }
        .btn-row { display: flex; flex-direction: column; gap: 10px; margin-top: 30px; }
        .btn-main-row { display: flex; gap: 10px; }
        button { flex: 1; padding: 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .save-btn { background: #fff; color: #000; }
        .cancel-btn { background: #222; color: #fff; }
        .reset-btn { background: transparent; color: #444; font-size: 11px; text-decoration: underline; margin-top: 5px; }

        @media (orientation: portrait) {
            #left { flex: 100; border-right: none; }
            #right { display: none; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="container">
    <div id="left">
        <section class="weather-section" style="border-bottom: 1px solid #1a1a1a;">
            <div id="date-today" class="section-label">--/-- ---</div>
            <div class="top-row">
                <div id="clock" class="clock-display">--:--</div>
                <div id="icon-now" class="icon-display"></div>
            </div>
            <div class="bottom-row">
                <div id="temp-now" class="temp-display">--°</div>
                <div class="details-group">
                    <div class="current-detail"><span class="detail-label">RAIN</span><span id="rain-now" class="num-val">--</span><span class="unit">%</span></div>
                    <div class="current-detail"><span class="detail-label">HUMI</span><span id="humi-now" class="num-val">--</span><span class="unit">%</span></div>
                </div>
            </div>
        </section>
        <section class="weather-section">
            <div id="date-tomorrow" class="section-label">--/-- ---</div>
            <div class="top-row"><div id="icon-tom" class="icon-display"></div></div>
            <div class="bottom-row">
                <div class="temp-stack">
                    <div id="temp-tom-max" class="temp-max-min">--°</div>
                    <div class="temp-divider"></div>
                    <div id="temp-tom-min" class="temp-max-min">--°</div>
                </div>
                <div class="details-group">
                    <div class="current-detail"><span class="detail-label">RAIN</span><span id="rain-tom" class="num-val">--</span><span class="unit">%</span></div>
                    <div class="current-detail"><span class="detail-label">HUMI</span><span id="humi-tom" class="num-val">--</span><span class="unit">%</span></div>
                </div>
            </div>
        </section>
    </div>
    <div id="right">
        <table>
            <thead>
                <tr>
                    <th>TIME</th>
                    <th>SKY</th>
                    <th>TEMP</th>
                    <th>RAIN</th>
                    <th>HUMI</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="forecast-body"></tbody>
        </table>
    </div>
</div>

<div id="overlay">
    <div id="modal">
        <h2>LOCATION SETTINGS</h2>
        <div class="input-group">
            <label>Latitude</label><input type="number" id="lat-input" step="0.0001">
        </div>
        <div class="input-group">
            <label>Longitude</label><input type="number" id="lon-input" step="0.0001">
        </div>
        <div class="btn-row">
            <div class="btn-main-row">
                <button class="cancel-btn" onclick="toggleSettings(false)">Cancel</button>
                <button class="save-btn" onclick="saveSettings()">Save</button>
            </div>
            <button class="reset-btn" onclick="resetToDefault()">Reset to Default Location</button>
        </div>
    </div>
</div>

<script>
    const DEFAULT_LOC = { lat: 34.7567, lon: 135.486 };
    let CONFIG = {
        lat: parseFloat(localStorage.getItem('lat')) || DEFAULT_LOC.lat,
        lon: parseFloat(localStorage.getItem('lon')) || DEFAULT_LOC.lon,
        updateFreq: 600000
    };

    let dailySunData = []; 
    let pressTimer;

    function toggleAccordion(parentIdx) {
        const children = document.querySelectorAll(`.child-of-${parentIdx}`);
        const icon = document.getElementById(`btn-${parentIdx}`);
        const isShowing = children[0].classList.contains('show');
        children.forEach(c => c.classList.toggle('show'));
        icon.textContent = isShowing ? '＋' : '－';
        icon.style.color = isShowing ? '#444' : '#fff';
    }

    const container = document.getElementById('container');
    const rightSide = document.getElementById('right');

    const handleStart = () => { pressTimer = setTimeout(() => { toggleSettings(true); pressTimer = null; }, 3000); };
    const handleEnd = (e) => { 
        if (pressTimer) { 
            clearTimeout(pressTimer); 
            pressTimer = null; 
            if (e.currentTarget === container && !rightSide.contains(e.target)) {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.();
                }
            }
        } 
    };

    container.addEventListener('mousedown', handleStart);
    container.addEventListener('touchstart', handleStart);
    container.addEventListener('mouseup', handleEnd);
    container.addEventListener('touchend', handleEnd);

    function toggleSettings(show) {
        document.getElementById('overlay').style.display = show ? 'flex' : 'none';
        if(show) {
            document.getElementById('lat-input').value = CONFIG.lat;
            document.getElementById('lon-input').value = CONFIG.lon;
        }
    }

    function saveSettings() {
        const lat = parseFloat(document.getElementById('lat-input').value);
        const lon = parseFloat(document.getElementById('lon-input').value);
        if (!isNaN(lat) && !isNaN(lon)) {
            CONFIG.lat = lat; CONFIG.lon = lon;
            localStorage.setItem('lat', lat); localStorage.setItem('lon', lon);
            toggleSettings(false); updateWeather();
        }
    }

    function resetToDefault() {
        document.getElementById('lat-input').value = DEFAULT_LOC.lat;
        document.getElementById('lon-input').value = DEFAULT_LOC.lon;
    }

    function isNight(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const dateStr = `${y}-${m}-${d}`;
        const sun = dailySunData.find(s => s.date === dateStr);
        
        if (!sun) return date.getHours() < 6 || date.getHours() > 18;

        const currentHourInMins = date.getHours() * 60; // 判定したい時間の「00分」時点の数値
        
        // 日の出判定
        if (date.getHours() < 12) {
            // 日の出が「時:30」より後なら、その「時」はまだ夜。
            // ちょうど30分なら、後の判定に従う＝夜。
            return currentHourInMins < (sun.sunrise - 30);
        } 
        // 日の入り判定
        else {
            // 日の入りが「時:30」より後なら、その「時」はまだ昼。
            // ちょうど30分なら、後の判定に従う＝昼。
            return currentHourInMins >= (sun.sunset + 30);
        }
    }

    function getIconHTML(code, date, forceDay = false) {
        const night = forceDay ? false : isNight(date);
        let icon = "wi-cloudy";
        if (code === 0) icon = night ? "wi-night-clear" : "wi-day-sunny";
        else if (code === 1) icon = night ? "wi-night-alt-partly-cloudy" : "wi-day-sunny-overcast";
        else if (code === 2) icon = night ? "wi-night-alt-cloudy" : "wi-day-cloudy";
        else if (code === 3) icon = "wi-cloudy";
        else if (code >= 51 && code <= 65) icon = "wi-rain";
        else if (code >= 71 && code <= 77) icon = "wi-snow";
        else if (code >= 80 && code <= 82) icon = "wi-showers";
        else if (code >= 95) icon = "wi-thunderstorm";
        return `<i class="wi ${icon}"></i>`;
    }

    async function updateWeather() {
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.lat}&longitude=${CONFIG.lon}&hourly=temperature_2m,precipitation_probability,relative_humidity_2m,weathercode&daily=sunrise,sunset,weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&current_weather=true&timezone=auto`;
            const res = await fetch(url);
            const data = await res.json();
            
            const now = new Date();
            const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1);
            const weeks = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            document.getElementById("date-today").textContent = `${now.getMonth()+1}/${now.getDate()} (${weeks[now.getDay()]})`;
            document.getElementById("date-tomorrow").textContent = `${tomorrow.getMonth()+1}/${tomorrow.getDate()} (${weeks[tomorrow.getDay()]})`;

            dailySunData = data.daily.time.map((date, i) => {
                const sr = new Date(data.daily.sunrise[i]);
                const ss = new Date(data.daily.sunset[i]);
                return { date, sunrise: sr.getHours()*60 + sr.getMinutes(), sunset: ss.getHours()*60 + ss.getMinutes() };
            });

            const currentHour = now.getHours();
            const startHour = Math.floor(currentHour / 6) * 6;
            const searchStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}T${String(startHour).padStart(2,'0')}:00`;
            const startIdx = data.hourly.time.findIndex(t => t.startsWith(searchStr));

            document.getElementById("icon-now").innerHTML = getIconHTML(data.current_weather.weathercode, now);
            document.getElementById("temp-now").textContent = `${Math.round(data.current_weather.temperature)}°`;
            document.getElementById("rain-now").textContent = data.hourly.precipitation_probability[startIdx + (currentHour - startHour)];
            document.getElementById("humi-now").textContent = data.hourly.relative_humidity_2m[startIdx + (currentHour - startHour)];

            document.getElementById("icon-tom").innerHTML = getIconHTML(data.daily.weathercode[1], tomorrow, true);
            document.getElementById("temp-tom-max").textContent = `${Math.round(data.daily.temperature_2m_max[1])}°`;
            document.getElementById("temp-tom-min").textContent = `${Math.round(data.daily.temperature_2m_min[1])}°`;
            document.getElementById("rain-tom").textContent = data.daily.precipitation_probability_max[1];
            
            const tomDateStr = data.daily.time[1];
            const tomHumiList = data.hourly.time.map((t, i) => t.startsWith(tomDateStr) ? data.hourly.relative_humidity_2m[i] : null).filter(v => v !== null);
            document.getElementById("humi-tom").textContent = tomHumiList.length ? Math.round(tomHumiList.reduce((a,b)=>a+b)/tomHumiList.length) : "--";

            let html = "";
            for(let i = 0; i < 24; i++) {
                const idx = startIdx + i;
                if(!data.hourly.time[idx]) break;
                const d_forecast = new Date(data.hourly.time[idx]);
                const h = d_forecast.getHours();
                const isParent = (h % 6 === 0);

                if (isParent) {
                    html += `<tr class="parent-row" onclick="toggleAccordion(${idx})">
                        <td class="time-data">${h}:00</td>
                        <td><span class="h-icon">${getIconHTML(data.hourly.weathercode[idx], d_forecast)}</span></td>
                        <td>${Math.round(data.hourly.temperature_2m[idx])}°</td>
                        <td>${data.hourly.precipitation_probability[idx]}%</td>
                        <td>${data.hourly.relative_humidity_2m[idx]}%</td>
                        <td id="btn-${idx}" class="toggle-icon">＋</td>
                    </tr>`;
                } else {
                    const parentIdx = idx - (h % 6);
                    html += `<tr class="child-row child-of-${parentIdx}">
                        <td class="time-data">${h}:00</td>
                        <td><span class="h-icon">${getIconHTML(data.hourly.weathercode[idx], d_forecast)}</span></td>
                        <td>${Math.round(data.hourly.temperature_2m[idx])}°</td>
                        <td>${data.hourly.precipitation_probability[idx]}%</td>
                        <td>${data.hourly.relative_humidity_2m[idx]}%</td>
                        <td></td>
                    </tr>`;
                }
            }
            document.getElementById("forecast-body").innerHTML = html;
        } catch (e) { console.error(e); }
    }

    function updateTime() {
        const n = new Date();
        document.getElementById("clock").textContent = `${String(n.getHours()).padStart(2, '0')}:${String(n.getMinutes()).padStart(2, '0')}`;
    }

    updateTime();
    updateWeather();
    setInterval(updateWeather, CONFIG.updateFreq);
    setInterval(updateTime, 1000);
</script>
</body>
</html>
